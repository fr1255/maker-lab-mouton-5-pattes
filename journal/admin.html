<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Admin Journal â€” Validation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#0b0f14;
      --card:#111824;
      --text:#e7eef7;
      --muted:#a9b4c4;
      --line:rgba(255,255,255,.12);
      --accent:#58a6ff;
      --good:#33d17a;
      --bad:#ff5c5c;
      --warn:#ffcc66;
      --radius:16px;
      --max:1100px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui, sans-serif;
      background:
        radial-gradient(900px 600px at 20% 10%, rgba(126,231,135,.12), transparent 60%),
        radial-gradient(900px 600px at 80% 0%, rgba(88,166,255,.14), transparent 55%),
        var(--bg);
      color:var(--text);
    }

    a{ color:var(--accent); text-decoration:none; }

    .wrap{
      max-width:var(--max);
      margin:0 auto;
      padding:40px 16px 60px;
    }

    h1{ margin:0 0 10px; }

    .panel{
      background: rgba(17,24,36,.7);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:18px;
      margin-top:18px;
    }

    .btn{
      background:#1f2a3a;
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      padding:.55rem .9rem;
      border-radius:12px;
      cursor:pointer;
      font-weight:650;
      font-size:14px;
    }

    .btn.good{ border-color: rgba(51,209,122,.35); }
    .btn.bad{ border-color: rgba(255,92,92,.35); }
    .btn.warn{ border-color: rgba(255,204,102,.35); }
    .btn.ghost{ background:transparent; color:var(--muted); }

    .tabs{
      display:flex;
      gap:8px;
      margin-top:14px;
      flex-wrap:wrap;
    }

    .pill{
      padding:6px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      cursor:pointer;
      font-size:13px;
      color:var(--muted);
    }

    .pill.active{
      border-color:var(--accent);
      color:var(--text);
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(280px,1fr));
      gap:14px;
      margin-top:14px;
    }

    .note{
      background: linear-gradient(180deg,#182233,#101826);
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      padding:14px;
    }

    .note h3{ margin:0 0 4px; font-size:15px; }
    .note p{ margin:6px 0 0; font-size:13px; color:var(--muted); white-space:pre-wrap; }

    .meta{
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }

    .badge{
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      font-size:11px;
      border:1px solid rgba(255,255,255,.14);
      margin-right:6px;
    }

    .badge.good{ border-color:rgba(51,209,122,.4); color:#7ee787; }
    .badge.warn{ border-color:rgba(255,204,102,.4); color:#ffd27d; }
    .badge.bad{ border-color:rgba(255,92,92,.4); color:#ff8c8c; }

    .actions{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:10px;
    }

    /* MODAL */
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.6);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .modal[hidden]{ display:none; }

    .modal__card{
      background:#0f1624;
      padding:16px;
      border-radius:16px;
      width:min(720px,100%);
      border:1px solid rgba(255,255,255,.12);
    }

    label{ display:block; margin-top:10px; font-size:13px; }
    input, textarea, select{
      width:100%;
      margin-top:4px;
      background:#0b0f14;
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      border-radius:10px;
      padding:8px;
    }

  </style>
</head>

<body>
<div class="wrap">
  <h1>Admin Journal â€” Validation</h1>

  <section class="panel">
    <input type="file" id="importFile" accept=".json">
    <button class="btn good" id="exportPublic">Exporter journal.public.json</button>
  </section>

  <section class="panel">
    <div class="tabs">
      <div class="pill active" data-tab="all">Tout</div>
      <div class="pill" data-tab="pending">En attente</div>
      <div class="pill" data-tab="published">PubliÃ©</div>
      <div class="pill" data-tab="rejected">RefusÃ©</div>
    </div>

    <div class="grid" id="grid"></div>
  </section>
</div>

<!-- MODAL -->
<div class="modal" id="editModal" hidden>
  <div class="modal__card">
    <h3>Modifier la note</h3>

    <input type="hidden" id="editId">

    <label>Titre
      <input id="editTitle">
    </label>

    <label>Zone
      <select id="editZone">
        <option value="banc">ðŸ›  Banc</option>
        <option value="etabli">ðŸªš Ã‰tabli</option>
        <option value="tas">ðŸªµ Tas</option>
      </select>
    </label>

    <label>Texte
      <textarea id="editText" rows="6"></textarea>
    </label>

    <div class="actions">
      <button class="btn ghost" id="cancelEdit">Annuler</button>
      <button class="btn good" id="saveEdit">Enregistrer</button>
    </div>
  </div>
</div>

<script>
(() => {
  const BASE_PATH = "/maker-lab-mouton-5-pattes";
  const PUBLIC_URL = `${BASE_PATH}/journal/journal.public.json`;
  const ZONES = ["banc","etabli","tas"];

  const state = new Map();
  let currentTab = "all";

  const grid = document.getElementById("grid");
  const importFile = document.getElementById("importFile");

  const editModal = document.getElementById("editModal");
  const editId = document.getElementById("editId");
  const editTitle = document.getElementById("editTitle");
  const editText = document.getElementById("editText");
  const editZone = document.getElementById("editZone");

  function normalize(n, stateVal){
    return {
      id: n.id,
      zone: ZONES.includes(n.zone) ? n.zone : "banc",
      title: n.title || "",
      text: n.text || "",
      images: n.images || [],
      createdAt: n.createdAt || Date.now(),
      state: stateVal
    };
  }

  async function loadPublic(){
    try{
      const r = await fetch(PUBLIC_URL,{cache:"no-store"});
      const j = await r.json();
      (j.notes||[]).forEach(n=>{
        state.set(n.id, normalize(n,"published"));
      });
    }catch{}
  }

  function render(){
    grid.innerHTML = "";
    [...state.values()]
      .filter(n => currentTab==="all" || n.state===currentTab)
      .sort((a,b)=>b.createdAt-a.createdAt)
      .forEach(n=>{
        const el = document.createElement("div");
        el.className="note";
        el.innerHTML=`
          <div class="meta">
            <span class="badge">${n.zone}</span>
            <span class="badge ${n.state==="published"?"good":n.state==="pending"?"warn":"bad"}">${n.state}</span>
          </div>
          <h3>${n.title||"Note"}</h3>
          <p>${n.text||""}</p>
          <div class="actions">
            <button class="btn small" data-a="publish">Publier</button>
            <button class="btn small" data-a="reject">Refuser</button>
            <button class="btn small" data-a="edit">Modifier</button>
          </div>
        `;
        el.querySelectorAll("button").forEach(b=>{
          b.onclick=()=>{
            if(b.dataset.a==="publish") n.state="published";
            if(b.dataset.a==="reject") n.state="rejected";
            if(b.dataset.a==="edit") openEdit(n);
            render();
          };
        });
        grid.appendChild(el);
      });
  }

  function openEdit(n){
    editId.value=n.id;
    editTitle.value=n.title;
    editText.value=n.text;
    editZone.value=n.zone;
    editModal.hidden=false;
  }

  document.getElementById("saveEdit").onclick=()=>{
    const n=state.get(editId.value);
    n.title=editTitle.value;
    n.text=editText.value;
    n.zone=editZone.value;
    editModal.hidden=true;
    render();
  };

  document.getElementById("cancelEdit").onclick=()=>editModal.hidden=true;

  document.querySelectorAll(".pill").forEach(p=>{
    p.onclick=()=>{
      document.querySelectorAll(".pill").forEach(x=>x.classList.remove("active"));
      p.classList.add("active");
      currentTab=p.dataset.tab;
      render();
    };
  });

  importFile.onchange=async()=>{
    const t=await importFile.files[0].text();
    const j=JSON.parse(t);
    (j.notes||[]).forEach(n=>{
      state.set(n.id, normalize(n,"pending"));
    });
    render();
  };

  document.getElementById("exportPublic").onclick=()=>{
    const notes=[...state.values()].filter(n=>n.state==="published")
      .map(({state,...r})=>r);
    const blob=new Blob([JSON.stringify({version:1,notes},null,2)],{type:"application/json"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="journal.public.json";
    a.click();
  };

  loadPublic().then(render);
})();
</script>
</body>
</html>
