<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Admin Journal ‚Äî Validation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#0b0f14;
      --card:#111824;
      --text:#e7eef7;
      --muted:#a9b4c4;
      --line:rgba(255,255,255,.12);
      --ok:#3ddc97;
      --bad:#ff6b6b;
      --radius:16px;
      --max:980px;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:system-ui, sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 20% 10%, rgba(126,231,135,.12), transparent 60%),
        radial-gradient(900px 600px at 80% 0%, rgba(88,166,255,.16), transparent 55%),
        var(--bg);
    }

    .wrap{
      max-width:var(--max);
      margin:0 auto;
      padding:96px 16px 60px;
    }

    h1{
      margin:0 0 8px;
      font-size:28px;
    }

    p{
      margin:0 0 14px;
      color:var(--muted);
      line-height:1.6;
      max-width:80ch;
    }

    .card{
      margin-top:14px;
      padding:16px;
      border-radius:var(--radius);
      background:rgba(17,24,36,.75);
      border:1px solid var(--line);
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }

    .btn{
      background:#1f2a3a;
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      padding:.55rem .9rem;
      border-radius:12px;
      cursor:pointer;
      font-weight:650;
      font-size:14px;
    }
    .btn:hover{ transform: translateY(-1px); }

    .btn.ghost{ background:transparent; color:var(--muted); }
    .btn.ok{ border-color: rgba(61,220,151,.55); }
    .btn.bad{ border-color: rgba(255,107,107,.55); }

    .small{
      font-size:12px;
      color:var(--muted);
      line-height:1.5;
    }

    code{ color:#cde1ff; }

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(320px, 1fr));
      gap:12px;
      margin-top:12px;
    }

    .note{
      background:linear-gradient(180deg,#182233,#101826);
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      padding:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }

    .meta{
      font-size:12px;
      color:var(--muted);
      margin-bottom:8px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .badge{
      display:inline-flex;
      gap:6px;
      align-items:center;
      border:1px solid rgba(255,255,255,.14);
      padding:3px 8px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      background:rgba(255,255,255,.04);
    }
    .badge.ok{ border-color:rgba(61,220,151,.45); color:rgba(61,220,151,.95); }
    .badge.bad{ border-color:rgba(255,107,107,.45); color:rgba(255,107,107,.95); }
    .badge.pending{ border-color:rgba(255,200,90,.45); color:rgba(255,200,90,.95); }

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:10px 0 6px;
    }

    input[type="text"], textarea, select{
      width:100%;
      background:#0b0f14;
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      border-radius:12px;
      padding:.6rem .65rem;
      outline:none;
      font-family:inherit;
    }

    textarea{
      min-height:110px;
      resize:vertical;
    }

    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }

    .images{
      display:grid;
      grid-template-columns:repeat(2, 1fr);
      gap:8px;
      margin-top:10px;
    }
    .images img{
      width:100%;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.08);
      display:block;
    }

    .top-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
  </style>

  <!-- GoatCounter -->
  <script
    data-goatcounter="https://fr1255.goatcounter.com/count"
    async
    src="//gc.zgo.at/count.js">
  </script>
</head>

<body>
  <div class="wrap">
    <h1>Admin Journal ‚Äî Validation</h1>
    <p class="small">
      1) Importe <code>journal-pending.json</code> (fichier t√©l√©charg√© depuis le Journal).<br>
      2) Valide / refuse les notes.<br>
      3) Exporte <code>journal.public.json</code>, puis remplace le fichier dans GitHub et commit.
    </p>

    <!-- 2 boutons -->
    <div class="card">
      <div class="row">
        <div class="top-actions">
          <label class="btn ghost" style="display:inline-flex; align-items:center; gap:.5rem; cursor:pointer;">
            Importer les notes
            <input id="inPending" type="file" accept="application/json" hidden>
          </label>

          <button class="btn ok" id="exportPublic">Exporter journal.public.json</button>
        </div>

        <div class="small" id="status"></div>
      </div>

      <p class="small" style="margin-top:10px;">
        ‚ö†Ô∏è Sur GitHub Pages, cette page n‚Äôest pas ‚Äúprot√©g√©e‚Äù. La protection r√©elle, c‚Äôest : seul l‚Äôadmin commit <code>journal.public.json</code>.
      </p>
    </div>

    <div class="card">
      <div class="meta">
        <span class="badge pending">‚è≥ import√©</span>
        <span class="badge ok">‚úÖ valid√©</span>
        <span class="badge bad">‚ùå refus√©</span>
      </div>
      <div class="grid" id="grid"></div>
    </div>
  </div>

<script>
(() => {
  const PUBLIC_JSON_URL = "journal.public.json";
  const ZONES = ["banc", "etabli", "tas"];
  const ZONE_LABEL = {banc:"üõ† Banc", etabli:"ü™ö √âtabli", tas:"ü™µ Tas"};

  const $ = (id) => document.getElementById(id);
  const grid = $("grid");
  const statusEl = $("status");

  let publicNotes = [];     // notes d√©j√† publiques (pour merge)
  let pendingNotes = [];    // notes import√©es
  let decisions = new Map(); // id -> "pending" | "approved" | "rejected"
  let edits = new Map();     // id -> {zone,title,text,images}

  function setStatus(msg){ statusEl.textContent = msg || ""; }

  function uid(){
    return (crypto?.randomUUID)
      ? crypto.randomUUID()
      : String(Date.now()) + Math.random().toString(16).slice(2);
  }

  function escapeAttr(s){
    return String(s ?? "")
      .replace(/&/g,"&amp;")
      .replace(/"/g,"&quot;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;");
  }

  function escapeText(s){
    return String(s ?? "")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;");
  }

  function normalizePublic(n){
    const zone = ZONES.includes(n.zone) ? n.zone : "banc";
    const createdAt = (typeof n.createdAt === "number") ? n.createdAt
                  : (typeof n.createdAt === "string") ? Date.parse(n.createdAt)
                  : Date.now();

    return {
      id: n.id || uid(),
      zone,
      title: typeof n.title === "string" ? n.title : "",
      text: typeof n.text === "string" ? n.text : (typeof n.body === "string" ? n.body : ""),
      images: Array.isArray(n.images) ? n.images.filter(x => typeof x === "string") : [],
      createdAt: Number.isFinite(createdAt) ? createdAt : Date.now()
    };
  }

  function normalizePending(n){
    const zone = ZONES.includes(n.zone) ? n.zone : "banc";
    const createdAt = (typeof n.createdAt === "number") ? n.createdAt
                    : (typeof n.createdAt === "string") ? Date.parse(n.createdAt)
                    : Date.now();

    return {
      id: n.id || uid(),
      zone,
      title: typeof n.title === "string" ? n.title : "",
      text: typeof n.text === "string" ? n.text : "",
      images: Array.isArray(n.images) ? n.images.filter(x => typeof x === "string") : [],
      createdAt: Number.isFinite(createdAt) ? createdAt : Date.now()
    };
  }

  async function loadPublic(){
    try{
      const res = await fetch(PUBLIC_JSON_URL, { cache:"no-store" });
      if(!res.ok) throw new Error("no public");
      const data = await res.json();
      const list = Array.isArray(data) ? data : data.notes;
      publicNotes = Array.isArray(list) ? list.map(normalizePublic) : [];
      setStatus(`Public charg√©: ${publicNotes.length} note(s).`);
    } catch {
      publicNotes = [];
      setStatus("Public: aucun (ou fichier absent).");
    }
  }

  function badgeFor(state){
    if(state === "approved") return `<span class="badge ok">‚úÖ valid√©</span>`;
    if(state === "rejected") return `<span class="badge bad">‚ùå refus√©</span>`;
    return `<span class="badge pending">‚è≥ import√©</span>`;
  }

  function render(){
    grid.innerHTML = "";
    if(!pendingNotes.length){
      grid.innerHTML = `<div class="small">Importe un <code>journal-pending.json</code> pour afficher des notes.</div>`;
      return;
    }

    pendingNotes.forEach(n => {
      const state = decisions.get(n.id) || "pending";
      const e = edits.get(n.id) || { zone:n.zone, title:n.title, text:n.text, images:n.images };

      const card = document.createElement("div");
      card.className = "note";
      card.innerHTML = `
        <div class="meta">
          ${badgeFor(state)}
          <span>id: <code>${n.id}</code></span>
        </div>

        <label>Zone</label>
        <select data-field="zone">
          ${ZONES.map(z => `<option value="${z}" ${e.zone===z?"selected":""}>${ZONE_LABEL[z]}</option>`).join("")}
        </select>

        <label>Titre</label>
        <input type="text" data-field="title" value="${escapeAttr(e.title)}" placeholder="Titre (optionnel)">

        <label>Texte</label>
        <textarea data-field="text" placeholder="Note">${escapeText(e.text)}</textarea>

        ${(e.images && e.images.length) ? `
          <div class="images">
            ${e.images.map(src => `<img src="${src}" alt="">`).join("")}
          </div>
          <div class="small" style="margin-top:6px;">Images: ${e.images.length} (elles seront publiques si valid√©es)</div>
        ` : `<div class="small" style="margin-top:8px;">Aucune image</div>`}

        <div class="actions">
          <button class="btn ok" data-act="approve">Valider</button>
          <button class="btn bad" data-act="reject">Refuser</button>
        </div>
      `;

      card.addEventListener("click", (ev) => {
        const b = ev.target.closest("[data-act]");
        if(!b) return;
        const act = b.getAttribute("data-act");
        if(act === "approve") decisions.set(n.id, "approved");
        if(act === "reject") decisions.set(n.id, "rejected");
        render();
      });

      card.addEventListener("input", (ev) => {
        const field = ev.target?.getAttribute?.("data-field");
        if(!field) return;
        const cur = edits.get(n.id) || { zone:n.zone, title:n.title, text:n.text, images:n.images };
        edits.set(n.id, { ...cur, [field]: ev.target.value });
      });

      grid.appendChild(card);
    });
  }

  function buildPublicMerged(){
    const approved = pendingNotes
      .filter(n => decisions.get(n.id) === "approved")
      .map(n => {
        const e = edits.get(n.id) || { zone:n.zone, title:n.title, text:n.text, images:n.images };
        return normalizePublic({
          id: n.id,
          zone: e.zone,
          title: e.title,
          text: e.text,
          images: e.images,
          createdAt: new Date().toISOString()
        });
      });

    // merge (√©vite doublons)
    const byId = new Map(publicNotes.map(n => [n.id, n]));
    for(const n of approved) byId.set(n.id, n);

    return Array.from(byId.values()).sort((a,b) => b.createdAt - a.createdAt);
  }

  function downloadJSON(filename, data){
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 500);
  }

  $("inPending").addEventListener("change", async () => {
    const file = $("inPending").files?.[0];
    if(!file) return;

    let txt = "";
    try { txt = await file.text(); }
    catch { alert("Impossible de lire le fichier."); return; }

    let data;
    try { data = JSON.parse(txt); }
    catch { alert("JSON invalide."); return; }

    const list = Array.isArray(data) ? data : data.notes;
    if(!Array.isArray(list)){ alert("Format non reconnu."); return; }

    pendingNotes = list.map(normalizePending);
    decisions = new Map(pendingNotes.map(n => [n.id, "pending"]));
    edits = new Map();

    setStatus(`Pending import√©: ${pendingNotes.length} note(s).`);
    render();
  });

  $("exportPublic").addEventListener("click", () => {
    const merged = buildPublicMerged();
    downloadJSON("journal.public.json", merged);

    const approvedCount = pendingNotes.filter(n => decisions.get(n.id) === "approved").length;
    alert(
      `Export pr√™t ‚úÖ\n` +
      `Notes valid√©es: ${approvedCount}\n\n` +
      `√âtape suivante : remplacer /journal/journal.public.json dans GitHub puis commit.`
    );
  });

  // Init
  loadPublic().then(render);
})();
</script>
</body>
</html>
