<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Admin Journal ‚Äî Validation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#0b0f14;
      --card:#111824;
      --text:#e7eef7;
      --muted:#a9b4c4;
      --line:rgba(255,255,255,.12);
      --accent:#58a6ff;
      --good:#33d17a;
      --bad:#ff5c5c;
      --warn:#ffcc66;
      --radius:16px;
      --max:1100px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui, sans-serif;
      background:
        radial-gradient(900px 600px at 20% 10%, rgba(126,231,135,.12), transparent 60%),
        radial-gradient(900px 600px at 80% 0%, rgba(88,166,255,.14), transparent 55%),
        var(--bg);
      color:var(--text);
    }

    a{ color:var(--accent); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    .wrap{
      max-width:var(--max);
      margin:0 auto;
      padding:40px 16px 60px;
    }

    h1{
      margin:0 0 8px;
      font-size:28px;
      letter-spacing:.2px;
    }

    .lead{
      margin:0 0 18px;
      color:var(--muted);
      line-height:1.6;
      max-width:80ch;
    }

    .panel{
      background: rgba(17,24,36,.70);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:18px;
      margin-top:18px;
    }

    .row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }

    .row-left{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .row-right{ color:var(--muted); font-size:13px; display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

    .btn{
      background:#1f2a3a;
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      padding:.55rem .9rem;
      border-radius:12px;
      cursor:pointer;
      font-weight:650;
      font-size:14px;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn.ghost{ background:transparent; color:var(--muted); }
    .btn.good{ border-color: rgba(51, 209, 122, .35); }
    .btn.bad{ border-color: rgba(255, 92, 92, .35); }
    .btn.warn{ border-color: rgba(255, 204, 102, .35); }

    .hint{
      margin-top:10px;
      color:var(--muted);
      font-size:13px;
      line-height:1.55;
    }

    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      cursor:pointer;
      font-size:13px;
      user-select:none;
    }
    .pill strong{ color:var(--text); font-weight:700; }
    .pill.active{
      border-color: rgba(88,166,255,.45);
      color: var(--text);
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap:14px;
      margin-top:14px;
    }

    .note{
      background: linear-gradient(180deg, #182233, #101826);
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      padding: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.4);
      transition: transform .2s ease, box-shadow .2s ease;
      min-height: 120px;
    }
    .note:hover{
      transform: translateY(-3px);
      box-shadow: 0 16px 45px rgba(0,0,0,.6);
    }

    .note__head{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
      margin-bottom:8px;
    }
    .note__title{
      margin:0;
      font-size:15px;
      color:#cde1ff;
      line-height:1.2;
    }
    .note__meta{
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(255,255,255,.12);
      color:var(--muted);
      white-space:nowrap;
      background: rgba(255,255,255,.03);
    }
    .badge.good{ border-color: rgba(51, 209, 122, .35); color: rgba(51, 209, 122, .95); }
    .badge.bad{ border-color: rgba(255, 92, 92, .35); color: rgba(255, 92, 92, .95); }
    .badge.warn{ border-color: rgba(255, 204, 102, .35); color: rgba(255, 204, 102, .95); }

    /* badge ‚Äúmode admin/visiteur‚Äù */
    .badge.mode { background: rgba(255,255,255,.03); }
    .badge.mode.admin { border-color: rgba(51, 209, 122, .35); color: rgba(51, 209, 122, .95); }
    .badge.mode.visitor { border-color: rgba(255, 204, 102, .35); color: rgba(255, 204, 102, .95); }

    /* badge zone */
    .badge.zone { border-color: rgba(88,166,255,.35); color: rgba(88,166,255,.95); }

    .note__text{
      color:var(--muted);
      font-size:13px;
      line-height:1.55;
      white-space: pre-wrap;
      margin: 10px 0 0 0;
    }

    .note__images{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:8px;
      margin-top:10px;
    }
    .note__images img{
      width:100%;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.08);
      display:block;
    }

    .actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:12px;
    }

    .chip{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color: var(--muted);
      padding:.35rem .55rem;
      border-radius:999px;
      cursor:pointer;
      font-size:12px;
      user-select:none;
    }
    .chip:hover{ color: var(--text); }

    .chip.good{ border-color: rgba(51, 209, 122, .35); color: rgba(51, 209, 122, .95); }
    .chip.bad{ border-color: rgba(255, 92, 92, .35); color: rgba(255, 92, 92, .95); }
    .chip.warn{ border-color: rgba(255, 204, 102, .35); color: rgba(255, 204, 102, .95); }

    .muted{ color:var(--muted); }

    /* Modal edit */
    .modal{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 1rem;
      z-index: 50;
    }
    .modal[hidden]{ display:none; }

    .modal__card{
      width:min(780px, 100%);
      background: #0f1624;
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding: 1rem;
      box-shadow: 0 30px 90px rgba(0,0,0,.65);
    }
    .modal__top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:.6rem;
    }
    .modal__card h2{
      margin:0;
      font-size:1rem;
      color: var(--text);
    }
    .icon-btn{
      background:transparent;
      border:none;
      color:var(--muted);
      cursor:pointer;
      font-size:1.05rem;
      line-height:1;
      padding:.2rem .25rem;
    }
    .icon-btn:hover{ color:var(--text); }

    label{
      display:block;
      margin-top:.75rem;
      color: var(--text);
      font-size:.85rem;
    }
    input[type="text"], textarea, select{
      width:100%;
      margin-top:.35rem;
      background:#0b0f14;
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      border-radius:12px;
      padding:.65rem .7rem;
      outline:none;
      font-family: inherit;
    }
    textarea{ resize: vertical; min-height: 140px; }

    .modal__actions{
      display:flex;
      justify-content:flex-end;
      gap:.6rem;
      margin-top:1rem;
      flex-wrap:wrap;
    }

    .small{
      font-size:12px;
      color:var(--muted);
      line-height:1.5;
      margin-top:8px;
    }

    .empty{
      padding:16px;
      border:1px dashed rgba(255,255,255,.18);
      border-radius:14px;
      color:var(--muted);
      background: rgba(255,255,255,.02);
    }

    /* ‚úÖ zone drop */
    .drop-hint{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,.20);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      font-size:13px;
      line-height:1.5;
    }
    body.dragover .drop-hint{
      border-color: rgba(88,166,255,.55);
      color: var(--text);
      background: rgba(88,166,255,.08);
    }
  </style>
</head>

<body>
<div class="wrap">
  <h1>Admin Journal ‚Äî Validation</h1>
  <p class="lead">
    1) Importer <strong>journal.pending.json</strong> (export√© depuis le Journal priv√©)<br>
    2) Publier / refuser / modifier / supprimer (en m√©moire)<br>
    3) Exporter <strong>journal.public.json</strong> et le remplacer dans GitHub (commit).
  </p>

  <section class="panel">
    <div class="row">
      <div class="row-left">
        <label class="btn" style="display:inline-flex; align-items:center; gap:.5rem; cursor:pointer;">
          Importer un fichier .json
          <input id="importPending" type="file" accept="application/json" hidden>
        </label>

        <button class="btn" id="pasteImport" title="Lit le presse-papier et colle le JSON (si autoris√©)">Importer depuis presse-papier</button>
        <button class="btn good" id="pasteApply" title="Parse le texte coll√© et importe les notes">Importer le texte coll√©</button>
        <button class="btn ghost" id="pasteClear" title="Effacer la zone de collage">Effacer</button>

        <button class="btn good" id="exportPublic">Exporter journal.public.json</button>

        <button class="btn ghost" id="resetSession" title="Revenir au public charg√© + vider les imports">
          R√©initialiser la session
        </button>

        <button class="btn warn" id="toggleAdmin" title="Marque ce navigateur comme ADMIN (ou le remet en visiteur)">
          Activer mode admin
        </button>
      </div>

      <div class="row-right">
        <span class="badge mode visitor" id="adminBadge">üß≠ mode visiteur</span>
        <span id="statusLine">‚Äî</span>
      </div>
    </div>

    <p class="hint">
      ‚ö†Ô∏è Sur GitHub Pages, cette page n‚Äôest pas ‚Äúprot√©g√©e‚Äù. La vraie protection, c‚Äôest : <strong>seul l‚Äôadmin commit</strong> le fichier <strong>journal.public.json</strong>.<br>
      Astuce : le bouton <strong>mode admin</strong> enregistre un flag dans ce navigateur (<code>localStorage</code>) ‚Äî tes autres pages peuvent s‚Äôen servir.
    </p>

    <label style="margin-top:10px;">
      Coller ici le JSON (bloc du mail ou contenu de journal.pending.json)
      <textarea id="pasteArea" placeholder='{"version":3,"notes":[...]}'></textarea>
    </label>
    <div class="small">
      Tu peux copier/coller tout le mail : l‚Äôadmin essaye de retrouver automatiquement le premier bloc <code>{...}</code>.
    </div>

    <div class="drop-hint">
      üí° Astuce : tu peux aussi <strong>glisser-d√©poser</strong> un fichier <code>journal.pending.json</code> n‚Äôimporte o√π sur cette page pour l‚Äôimporter.
    </div>
  </section>

  <section class="panel">
    <div class="tabs" id="tabs">
      <div class="pill active" data-tab="all">Tout <strong id="countAll">0</strong></div>
      <div class="pill" data-tab="pending">üïí En attente <strong id="countPending">0</strong></div>
      <div class="pill" data-tab="published">‚úÖ Publi√© <strong id="countPublished">0</strong></div>
      <div class="pill" data-tab="rejected">‚ùå Refus√© <strong id="countRejected">0</strong></div>
      <div class="pill" data-tab="deleted">üóë Supprim√© <strong id="countDeleted">0</strong></div>
    </div>

    <div class="hint">
      <span class="muted">Chaque action modifie uniquement l‚Äô√©tat en m√©moire. Rien n‚Äôest publi√© tant que tu n‚Äôexportes pas puis commits.</span>
    </div>

    <div class="grid" id="notesGrid" aria-label="Liste de notes"></div>
    <div id="emptyState" class="empty" hidden>Importe un <strong>journal.pending.json</strong> pour afficher des notes (ou charge le public existant).</div>
  </section>
</div>

<!-- Modal edit -->
<section class="modal" id="editModal" hidden>
  <div class="modal__card" role="dialog" aria-modal="true" aria-label="Modifier une note">
    <div class="modal__top">
      <h2>Modifier la note</h2>
      <button class="icon-btn" id="closeEdit" aria-label="Fermer">‚úï</button>
    </div>

    <form id="editForm">
      <input type="hidden" id="editId">

      <label>
        Titre
        <input type="text" id="editTitle" maxlength="120" placeholder="Titre (optionnel)">
      </label>

      <label>
        Zone
        <select id="editZone">
          <option value="banc">üõ† banc</option>
          <option value="etabli">ü™ö etabli</option>
          <option value="tas">ü™µ tas</option>
        </select>
      </label>

      <label>
        Texte
        <textarea id="editText" maxlength="8000" placeholder="Texte‚Ä¶"></textarea>
      </label>

      <label>
        Images (DataURL) ‚Äî option avanc√©e
        <textarea id="editImages" placeholder='Un tableau JSON de DataURL, ex: ["data:image/png;base64,..."]'></textarea>
        <div class="small">
          Tu peux laisser vide. (Les images import√©es depuis le Journal sont conserv√©es telles quelles.)<br>
          Note : stocker beaucoup d‚Äôimages en DataURL rend les JSON lourds.
        </div>
      </label>

      <div class="modal__actions">
        <button type="button" class="btn ghost" id="cancelEdit">Annuler</button>
        <button type="submit" class="btn good">Enregistrer</button>
      </div>
    </form>
  </div>
</section>

<script>
(() => {
  // Adapter si besoin
  const BASE_PATH = "/maker-lab-mouton-5-pattes";
  const PUBLIC_URL = `${BASE_PATH}/journal/journal.public.json`;
  const ZONES = ["banc","etabli","tas"];

  /* =========================
     ‚úÖ MODE ADMIN (localStorage)
     ========================= */
  const ADMIN_KEY = "ml_is_admin";
  function isAdminBrowser(){ return localStorage.getItem(ADMIN_KEY) === "true"; }
  function setAdminBrowser(v){
    if (v) localStorage.setItem(ADMIN_KEY, "true");
    else localStorage.removeItem(ADMIN_KEY);
  }

  const toggleAdminBtn = document.getElementById("toggleAdmin");
  const adminBadge = document.getElementById("adminBadge");

  function updateAdminUI(){
    const on = isAdminBrowser();
    if (on){
      adminBadge.textContent = "‚úÖ mode admin";
      adminBadge.classList.remove("visitor");
      adminBadge.classList.add("admin");
      toggleAdminBtn.textContent = "D√©sactiver mode admin";
      toggleAdminBtn.classList.remove("warn");
      toggleAdminBtn.classList.add("ghost");
    } else {
      adminBadge.textContent = "üß≠ mode visiteur";
      adminBadge.classList.remove("admin");
      adminBadge.classList.add("visitor");
      toggleAdminBtn.textContent = "Activer mode admin";
      toggleAdminBtn.classList.remove("ghost");
      toggleAdminBtn.classList.add("warn");
    }
  }
  toggleAdminBtn.addEventListener("click", () => {
    setAdminBrowser(!isAdminBrowser());
    updateAdminUI();
  });
  updateAdminUI();

  const importPendingInput = document.getElementById("importPending");
  const exportPublicBtn = document.getElementById("exportPublic");
  const resetBtn = document.getElementById("resetSession");
  const statusLine = document.getElementById("statusLine");

  const tabs = document.getElementById("tabs");
  const notesGrid = document.getElementById("notesGrid");
  const emptyState = document.getElementById("emptyState");

  const countAll = document.getElementById("countAll");
  const countPending = document.getElementById("countPending");
  const countPublished = document.getElementById("countPublished");
  const countRejected = document.getElementById("countRejected");
  const countDeleted = document.getElementById("countDeleted");

  const editModal = document.getElementById("editModal");
  const closeEditBtn = document.getElementById("closeEdit");
  const cancelEditBtn = document.getElementById("cancelEdit");
  const editForm = document.getElementById("editForm");
  const editId = document.getElementById("editId");
  const editTitle = document.getElementById("editTitle");
  const editZone = document.getElementById("editZone");
  const editText = document.getElementById("editText");
  const editImages = document.getElementById("editImages");

  // presse-papier UI
  const pasteImportBtn = document.getElementById("pasteImport");
  const pasteApplyBtn = document.getElementById("pasteApply");
  const pasteClearBtn = document.getElementById("pasteClear");
  const pasteArea = document.getElementById("pasteArea");

  let currentTab = "all";

  // Store
  // state: pending | published | rejected | deleted
  const stateById = new Map();

  function setStatus(msg){ statusLine.textContent = msg; }

  function escapeHtml(str) {
    return (str || "").replace(/[&<>"']/g, (m) => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
    }[m]));
  }

  function formatDate(ts) {
    if (!ts) return "‚Äî";
    const d = new Date(ts);
    if (isNaN(d.getTime())) return "‚Äî";
    return d.toLocaleString("fr-FR", { dateStyle: "medium", timeStyle: "short" });
  }

  // ‚úÖ IMPORTANT : conserve zone
  function normalizeIncoming(incoming, defaultState) {
    const arr = Array.isArray(incoming) ? incoming : (incoming?.notes || []);
    if (!Array.isArray(arr)) return [];

    return arr.map(n => ({
      id: (typeof n.id === "string" && n.id) ? n.id : String(Date.now()) + Math.random().toString(16).slice(2),
      zone: ZONES.includes(n.zone) ? n.zone : "banc",
      title: typeof n.title === "string" ? n.title : "",
      text: typeof n.text === "string" ? n.text : (typeof n.body === "string" ? n.body : ""),
      images: Array.isArray(n.images) ? n.images.filter(x => typeof x === "string") : [],
      createdAt: (typeof n.createdAt === "number") ? n.createdAt : Date.now(),
      state: n.state && ["pending","published","rejected","deleted"].includes(n.state) ? n.state : defaultState
    }))
    .filter(n => (n.title.trim() || n.text.trim() || (n.images && n.images.length)));
  }

  function computeCounts() {
    const all = Array.from(stateById.values());
    const counts = {
      all: all.filter(n => n.state !== "deleted").length,
      pending: all.filter(n => n.state === "pending").length,
      published: all.filter(n => n.state === "published").length,
      rejected: all.filter(n => n.state === "rejected").length,
      deleted: all.filter(n => n.state === "deleted").length,
    };
    countAll.textContent = counts.all;
    countPending.textContent = counts.pending;
    countPublished.textContent = counts.published;
    countRejected.textContent = counts.rejected;
    countDeleted.textContent = counts.deleted;
  }

  function getBadge(note) {
    if (note.state === "published") return `<span class="badge good">‚úÖ publi√©</span>`;
    if (note.state === "pending") return `<span class="badge warn">üïí en attente</span>`;
    if (note.state === "rejected") return `<span class="badge bad">‚ùå refus√©</span>`;
    if (note.state === "deleted") return `<span class="badge">üóë supprim√©</span>`;
    return `<span class="badge">‚Äî</span>`;
  }

  function filterByTab(note) {
    if (currentTab === "all") return note.state !== "deleted";
    return note.state === currentTab;
  }

  function noteCardHTML(n){
    const title = n.title?.trim() ? escapeHtml(n.title.trim()) : "Note";
    const text = n.text?.trim() ? escapeHtml(n.text.trim()) : "";

    const imagesHtml = (n.images && n.images.length)
      ? `<div class="note__images">${n.images.slice(0,6).map(src => `<img src="${src}" alt="">`).join("")}</div>`
      : "";

    return `
      <article class="note" data-id="${escapeHtml(n.id)}">
        <div class="note__head">
          <div>
            <h3 class="note__title">${title}</h3>
            <div class="note__meta">
              <span class="badge zone">zone: ${escapeHtml(n.zone || "banc")}</span>
              <span>${formatDate(n.createdAt)}</span>
            </div>
          </div>
          ${getBadge(n)}
        </div>

        ${text ? `<p class="note__text">${text}</p>` : ""}
        ${imagesHtml}

        <div class="actions">
          <button class="chip good" data-action="publish">Publier</button>
          <button class="chip warn" data-action="pending">Mettre en attente</button>
          <button class="chip bad" data-action="reject">Refuser</button>
          <button class="chip" data-action="edit">Modifier</button>
          <button class="chip" data-action="delete">Supprimer</button>
        </div>
      </article>
    `;
  }

  function render() {
    computeCounts();
    const notes = Array.from(stateById.values())
      .filter(filterByTab)
      .sort((a,b) => (b.createdAt || 0) - (a.createdAt || 0));

    emptyState.hidden = (stateById.size !== 0);
    if (stateById.size === 0) { notesGrid.innerHTML = ""; return; }

    if (notes.length === 0) {
      notesGrid.innerHTML = `<div class="empty">Aucune note dans cet onglet.</div>`;
      return;
    }

    notesGrid.innerHTML = notes.map(noteCardHTML).join("");
  }

  function upsertMany(list, sourceLabel) {
    let added = 0;
    let updated = 0;

    for (const n of list) {
      const existing = stateById.get(n.id);
      if (!existing) {
        stateById.set(n.id, n);
        added++;
      } else {
        stateById.set(n.id, {
          ...existing,
          zone: n.zone,            // ‚úÖ conserve zone
          title: n.title,
          text: n.text,
          images: n.images,
          createdAt: n.createdAt || existing.createdAt,
          state: existing.state    // garde l'√©tat d√©j√† choisi
        });
        updated++;
      }
    }
    setStatus(`${sourceLabel}: +${added} ajout√©(s), ${updated} mis √† jour.`);
  }

  async function loadPublicFromSite() {
    try {
      const res = await fetch(PUBLIC_URL, { cache: "no-store" });
      if (!res.ok) return { ok:false, notes: [] };
      const data = await res.json();
      const normalized = normalizeIncoming(data, "published").map(n => ({ ...n, state: "published" }));
      return { ok:true, notes: normalized };
    } catch {
      return { ok:false, notes: [] };
    }
  }

  function downloadJSON(obj, filename) {
    const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 500);
  }

  // extract JSON from mail
  function extractFirstJsonObject(str){
    const s = String(str || "");
    const first = s.indexOf("{");
    const last = s.lastIndexOf("}");
    if (first >= 0 && last > first) return s.slice(first, last + 1);
    return s.trim();
  }

  async function importFromText(rawText, sourceLabel){
    const raw = extractFirstJsonObject(rawText);
    if (!raw) throw new Error("empty");

    let data;
    try { data = JSON.parse(raw); }
    catch { throw new Error("json"); }

    const normalized = normalizeIncoming(data, "pending").map(n => ({ ...n, state: "pending" }));
    upsertMany(normalized, sourceLabel);
    render();
    return normalized.length;
  }

  // Clipboard import
  pasteImportBtn?.addEventListener("click", async () => {
    try{
      const t = await navigator.clipboard.readText();
      pasteArea.value = extractFirstJsonObject(t || "");
      setStatus("Presse-papier coll√©. Clique ¬´ Importer le texte coll√© ¬ª.");
    }catch{
      alert("Impossible de lire le presse-papier.\nCopie le JSON puis colle-le manuellement dans la zone.");
    }
  });

  pasteClearBtn?.addEventListener("click", () => { pasteArea.value = ""; });

  pasteApplyBtn?.addEventListener("click", async () => {
    const raw = pasteArea.value || "";
    if (!raw.trim()) { alert("Colle d‚Äôabord un JSON."); return; }
    try{
      const n = await importFromText(raw, "Import coll√©");
      setStatus(`Import coll√©: ${n} note(s).`);
    }catch(err){
      alert(err.message === "json" ? "JSON invalide." : "Rien √† importer.");
    }
  });

  // Drag & Drop
  async function importFileObject(file, label){
    const txt = await file.text();
    await importFromText(txt, label);
  }

  window.addEventListener("dragover", (e) => {
    e.preventDefault();
    document.body.classList.add("dragover");
  });

  window.addEventListener("dragleave", () => {
    document.body.classList.remove("dragover");
  });

  window.addEventListener("drop", async (e) => {
    e.preventDefault();
    document.body.classList.remove("dragover");

    const file = e.dataTransfer?.files?.[0];
    if (!file) return;

    if (!/json/i.test(file.type) && !/\.json$/i.test(file.name)) {
      alert("D√©pose un fichier .json (journal.pending.json).");
      return;
    }

    try{
      await importFileObject(file, "Import (drag&drop)");
      setStatus(`Import (drag&drop): ${file.name}`);
    }catch{
      alert("Impossible d‚Äôimporter ce fichier (JSON invalide ?).");
    }
  });

  // Tabs
  tabs.addEventListener("click", (e) => {
    const pill = e.target.closest(".pill");
    if (!pill) return;
    const tab = pill.getAttribute("data-tab");
    if (!tab) return;

    currentTab = tab;
    tabs.querySelectorAll(".pill").forEach(p => p.classList.remove("active"));
    pill.classList.add("active");
    render();
  });

  // Note actions
  notesGrid.addEventListener("click", (e) => {
    const btn = e.target.closest("[data-action]");
    if (!btn) return;

    const action = btn.getAttribute("data-action");
    const noteEl = btn.closest(".note");
    const id = noteEl?.getAttribute("data-id");
    if (!id) return;

    const note = stateById.get(id);
    if (!note) return;

    if (action === "publish") { note.state = "published"; stateById.set(id, note); render(); return; }
    if (action === "pending") { note.state = "pending"; stateById.set(id, note); render(); return; }
    if (action === "reject")  { note.state = "rejected"; stateById.set(id, note); render(); return; }

    if (action === "delete") {
      const ok = confirm("Supprimer d√©finitivement cette note (elle ne sera plus export√©e) ?");
      if (!ok) return;
      note.state = "deleted";
      stateById.set(id, note);
      render();
      return;
    }

    if (action === "edit") {
      editId.value = note.id;
      editTitle.value = note.title || "";
      editZone.value = ZONES.includes(note.zone) ? note.zone : "banc";
      editText.value = note.text || "";
      editImages.value = (note.images && note.images.length) ? JSON.stringify(note.images, null, 2) : "";
      editModal.hidden = false;
      editTitle.focus();
      return;
    }
  });

  function closeEdit() {
    editModal.hidden = true;
    editForm.reset();
  }

  closeEditBtn.addEventListener("click", closeEdit);
  cancelEditBtn.addEventListener("click", closeEdit);
  editModal.addEventListener("click", (e) => { if (e.target === editModal) closeEdit(); });

  editForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const id = editId.value;
    const note = stateById.get(id);
    if (!note) return;

    note.title = editTitle.value || "";
    note.zone = ZONES.includes(editZone.value) ? editZone.value : "banc";
    note.text = editText.value || "";

    const raw = (editImages.value || "").trim();
    if (raw) {
      try {
        const arr = JSON.parse(raw);
        if (Array.isArray(arr)) note.images = arr.filter(x => typeof x === "string");
        else { alert("Images: attendu un tableau JSON."); return; }
      } catch {
        alert("Images: JSON invalide.");
        return;
      }
    }
    stateById.set(id, note);
    closeEdit();
    render();
  });

  // Import file input
  importPendingInput.addEventListener("change", async () => {
    const file = importPendingInput.files?.[0];
    if (!file) return;
    try{
      await importFileObject(file, "Import fichier");
      importPendingInput.value = "";
      render();
    }catch{
      alert("Impossible d‚Äôimporter le fichier (JSON invalide ?).");
      importPendingInput.value = "";
    }
  });

  // Export public (published only)
  exportPublicBtn.addEventListener("click", () => {
    const notes = Array.from(stateById.values())
      .filter(n => n.state === "published")
      .sort((a,b) => (b.createdAt || 0) - (a.createdAt || 0))
      .map(({ state, ...rest }) => rest); // ‚úÖ garde zone/images/etc.

    const payload = {
      version: 1,
      exportedAt: new Date().toISOString(),
      notes
    };

    downloadJSON(payload, "journal.public.json");
    setStatus(`Export: ${notes.length} note(s) publi√©e(s) export√©e(s).`);
  });

  // Reset
  resetBtn.addEventListener("click", async () => {
    const ok = confirm("R√©initialiser la session ? (tu perds les modifications non export√©es)");
    if (!ok) return;
    stateById.clear();
    await bootstrap();
  });

  async function bootstrap() {
    setStatus("Chargement du public‚Ä¶");
    const pub = await loadPublicFromSite();
    if (pub.ok) {
      upsertMany(pub.notes, "Public charg√©");
      setStatus(`Public charg√©: ${pub.notes.length} note(s).`);
    } else {
      setStatus("Public non trouv√© (ok si premier lancement).");
    }
    render();
  }

  bootstrap();
})();
</script>
</body>
</html>
